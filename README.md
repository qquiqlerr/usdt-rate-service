# USDT Rate Service

–ú–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏ —Ö—Ä–∞–Ω–µ–Ω–∏—è –∫—É—Ä—Å–æ–≤ –≤–∞–ª—é—Ç USDT —á–µ—Ä–µ–∑ gRPC API. –°–µ—Ä–≤–∏—Å –ø–æ–ª—É—á–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –≥–ª—É–±–∏–Ω—ã —Ä—ã–Ω–∫–∞ –æ—Ç –±–∏—Ä–∂–∏ Grinex –∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –∫—É—Ä—Å—ã –ø–æ–∫—É–ø–∫–∏ –∏ –ø—Ä–æ–¥–∞–∂–∏.

## –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

- ‚ö° gRPC API –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫—É—Ä—Å–æ–≤ –≤–∞–ª—é—Ç
- üèõÔ∏è –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –±–∏—Ä–∂–µ–π Grinex
- üóÑÔ∏è –•—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ PostgreSQL
- üîÑ –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –≥–ª—É–±–∏–Ω—ã —Ä—ã–Ω–∫–∞
- üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å Zap
- üê≥ Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏–∑–∞—Ü–∏—è
- üß™ –Æ–Ω–∏—Ç-—Ç–µ—Å—Ç—ã —Å –º–æ–∫–∞–º–∏

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   gRPC Client   ‚îÇ    ‚îÇ  Rates Service  ‚îÇ    ‚îÇ   Grinex API    ‚îÇ
‚îÇ                 ‚îÇ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ                 ‚îÇ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ                 ‚îÇ
‚îÇ                 ‚îÇ    ‚îÇ                 ‚îÇ    ‚îÇ                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                               ‚îÇ
                               ‚ñº
                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                    ‚îÇ   PostgreSQL    ‚îÇ
                    ‚îÇ                 ‚îÇ
                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

- **gRPC Handler** - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ö–æ–¥—è—â–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- **Rates Service** - –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫—É—Ä—Å–æ–≤
- **Depth Provider** - –∞–¥–∞–ø—Ç–µ—Ä –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö —Å Grinex
- **Repository** - —Å–ª–æ–π –¥–æ—Å—Ç—É–ø–∞ –∫ –¥–∞–Ω–Ω—ã–º PostgreSQL

## –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

- Go 1.23+
- PostgreSQL 15+
- Docker & Docker Compose
- Protocol Buffers compiler (protoc)

## –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### 1. –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è

```bash
git clone <repository-url>
cd usdt-rate-service
```

### 2. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

```bash
go mod download
```

### 3. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è Protocol Buffers

```bash
make proto
```

### 4. –ó–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ Docker Compose

```bash
make run
# –∏–ª–∏
docker-compose -f build/docker-compose.yml up --build
```

–°–µ—Ä–≤–∏—Å –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É `50052`.

### 5. –õ–æ–∫–∞–ª—å–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞

```bash
# –ó–∞–ø—É—Å–∫ —Ç–æ–ª—å–∫–æ PostgreSQL
docker-compose -f build/docker-compose.yml up postgres migrations

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
export GRPC_ADDRESS=:50051
export DATABASE_ADDRESS="postgres://usdt_user:usdt_password@localhost:5432/usdt_rates?sslmode=disable"
export GRINEX_ADDRESS="https://grinex.io"
export LOG_LEVEL=debug

# –°–±–æ—Ä–∫–∞ –∏ –∑–∞–ø—É—Å–∫
make build
./bin/usdt-rate-service
```

## API

### gRPC –º–µ—Ç–æ–¥—ã

#### GetRates
–ü–æ–ª—É—á–µ–Ω–∏–µ –∞–∫—Ç—É–∞–ª—å–Ω–æ–≥–æ –∫—É—Ä—Å–∞ –¥–ª—è —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ —Ä—ã–Ω–∫–∞.

```protobuf
rpc GetRates(GetRatesRequest) returns (GetRatesResponse);

message GetRatesRequest {
  string market = 1;  // –Ω–∞–ø—Ä–∏–º–µ—Ä, "usdtrub"
}

message GetRatesResponse {
  Rate rate = 1;
}

message Rate {
  string askPrice = 1;   // —Ü–µ–Ω–∞ –ø—Ä–æ–¥–∞–∂–∏
  string bidPrice = 2;   // —Ü–µ–Ω–∞ –ø–æ–∫—É–ø–∫–∏  
  int64 timestamp = 3;   // –≤—Ä–µ–º–µ–Ω–Ω–∞—è –º–µ—Ç–∫–∞
}
```

#### HealthCheck
–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ—Ä–≤–∏—Å–∞.

```protobuf
rpc HealthCheck(HealthCheckRequest) returns (HealthCheckResponse);
```

### –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

```bash
# –ò—Å–ø–æ–ª—å–∑—É—è grpcurl
grpcurl -plaintext -d '{"market":"usdtrub"}' localhost:50052 rates.RatesService/GetRates

# –†–µ–∑—É–ª—å—Ç–∞—Ç
{
  "rate": {
    "askPrice": "102.50",
    "bidPrice": "102.30", 
    "timestamp": 1737901234
  }
}
```

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏–ª–∏ —Ñ–ª–∞–≥–∏ –∫–æ–º–∞–Ω–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏:

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–∫—Ä—É–∂–µ–Ω–∏—è | –§–ª–∞–≥ | –û–ø–∏—Å–∞–Ω–∏–µ | –ü—Ä–∏–º–µ—Ä |
|---------------------|------|----------|---------|
| `GRPC_ADDRESS` | `-grpc-addr` | –ê–¥—Ä–µ—Å gRPC —Å–µ—Ä–≤–µ—Ä–∞ | `:50051` |
| `DATABASE_ADDRESS` | `-db-addr` | –°—Ç—Ä–æ–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î | `postgres://user:pass@host:port/db` |
| `GRINEX_ADDRESS` | `-grinex-addr` | URL API Grinex | `https://grinex.io` |
| `LOG_LEVEL` | `-log-level` | –£—Ä–æ–≤–µ–Ω—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è | `debug`, `info`, `warn`, `error` |

## –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
usdt-rate-service/
‚îú‚îÄ‚îÄ api/proto/          # Protocol Buffers –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è
‚îú‚îÄ‚îÄ build/              # Docker Compose –∏ –º–∏–≥—Ä–∞—Ü–∏–∏
‚îú‚îÄ‚îÄ cmd/                # –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
‚îú‚îÄ‚îÄ config/             # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îú‚îÄ‚îÄ internal/           # –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –∫–æ–¥
‚îÇ   ‚îú‚îÄ‚îÄ adapter/        # –ê–¥–∞–ø—Ç–µ—Ä—ã –≤–Ω–µ—à–Ω–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
‚îÇ   ‚îú‚îÄ‚îÄ handler/grpc/   # gRPC –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
‚îÇ   ‚îú‚îÄ‚îÄ infra/grinex/   # –ö–ª–∏–µ–Ω—Ç –¥–ª—è Grinex API
‚îÇ   ‚îú‚îÄ‚îÄ models/         # –ú–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö
‚îÇ   ‚îú‚îÄ‚îÄ pb/             # –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ Protocol Buffers
‚îÇ   ‚îú‚îÄ‚îÄ repository/     # –°–ª–æ–π –¥–æ—Å—Ç—É–ø–∞ –∫ –¥–∞–Ω–Ω—ã–º
‚îÇ   ‚îú‚îÄ‚îÄ server/grpc/    # gRPC —Å–µ—Ä–≤–µ—Ä
‚îÇ   ‚îî‚îÄ‚îÄ service/        # –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞
‚îú‚îÄ‚îÄ mocks/              # –ú–æ–∫–∏ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
‚îî‚îÄ‚îÄ pkg/                # –û–±—â–∏–µ —É—Ç–∏–ª–∏—Ç—ã
```

### –ö–æ–º–∞–Ω–¥—ã Make

```bash
make proto        # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è Protocol Buffers
make mocks        # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –º–æ–∫–æ–≤
make build        # –°–±–æ—Ä–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
make test         # –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤
make lint         # –õ–∏–Ω—Ç–∏–Ω–≥ –∫–æ–¥–∞
make docker-build # –°–±–æ—Ä–∫–∞ Docker –æ–±—Ä–∞–∑–∞
make run          # –ó–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ Docker Compose
```

### –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –º–æ–∫–æ–≤

```bash
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ mockery
go install github.com/vektra/mockery/v2@latest

# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –º–æ–∫–æ–≤
make mocks
```

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

```bash
# –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤
make test

# –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ —Å –ø–æ–∫—Ä—ã—Ç–∏–µ–º
go test -cover ./...

# –ó–∞–ø—É—Å–∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞
go test -run TestRatesService_GetRates ./internal/service/
```

## –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

### –ú–∏–≥—Ä–∞—Ü–∏–∏

–ú–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ `build/migrations/postgres/` –∏ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ —á–µ—Ä–µ–∑ Docker Compose.

### –°—Ö–µ–º–∞ —Ç–∞–±–ª–∏—Ü—ã rates

```sql
CREATE TABLE rates (
    id SERIAL PRIMARY KEY,
    market VARCHAR(20) NOT NULL,
    ask DECIMAL(20,8) NOT NULL,
    bid DECIMAL(20,8) NOT NULL,
    timestamp BIGINT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_rates_market_timestamp ON rates(market, timestamp);
```

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–°–µ—Ä–≤–∏—Å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –±–∏–±–ª–∏–æ—Ç–µ–∫–æ–π Zap. –õ–æ–≥–∏ –≤–∫–ª—é—á–∞—é—Ç:

- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–∞–ø—Ä–æ—Å–∞—Ö –∏ –æ—Ç–≤–µ—Ç–∞—Ö
- –û—à–∏–±–∫–∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å –≤–Ω–µ—à–Ω–∏–º–∏ API
- –ú–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- –û—Ç–ª–∞–¥–æ—á–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é (–ø—Ä–∏ —É—Ä–æ–≤–Ω–µ debug)

–ü—Ä–∏–º–µ—Ä –ª–æ–≥–∞:
```json
{
  "level": "info",
  "ts": 1737901234.123,
  "caller": "service/rates.go:65",
  "msg": "Rate saved successfully",
  "service": "RatesService",
  "method": "GetRates",
  "market": "usdtrub",
  "rate": {
    "market": "usdtrub",
    "ask": "102.50",
    "bid": "102.30",
    "timestamp": 1737901234
  }
}
```

## –ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ

### Docker –æ–±—Ä–∞–∑

```bash
# –°–±–æ—Ä–∫–∞ –æ–±—Ä–∞–∑–∞
make docker-build

# –ó–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
docker run -p 50051:50051 \
  -e GRPC_ADDRESS=:50051 \
  -e DATABASE_ADDRESS="postgres://..." \
  -e GRINEX_ADDRESS="https://grinex.io" \
  -e LOG_LEVEL=info \
  usdt-rate-service:latest
```

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞

- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å connection pooling –¥–ª—è PostgreSQL
- –ù–∞—Å—Ç—Ä–æ–∏—Ç—å healthcheck endpoints
- –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏ Prometheus
- –ù–∞—Å—Ç—Ä–æ–∏—Ç—å graceful shutdown
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å TLS –¥–ª—è gRPC —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
- –î–æ–±–∞–≤–∏—Ç—å rate limiting
- –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ alerting

## –õ–∏—Ü–µ–Ω–∑–∏—è

[MIT License](LICENSE)

## –ö–æ–Ω—Ç–∞–∫—Ç—ã

–î–ª—è –≤–æ–ø—Ä–æ—Å–æ–≤ –∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π —Å–æ–∑–¥–∞–≤–∞–π—Ç–µ issues –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏.